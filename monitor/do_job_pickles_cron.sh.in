#!/bin/bash
set -eu

prog=$(basename $0)
prog_dir=$(readlink -f $(dirname $0))

export PATH=@PYTHON_PATH@:$prog_dir:$PATH

tmp_dir=${tmp_dir:-/dev/shm/}
dst_dir=${dst_dir:-@PICKLES_DIR@}

d0=$(date --date=yesterday +%F)
d1=$(date --date=today +%F)

exec 0< /dev/null
exec 1> $tmp_dir/$prog.out.$d0.$d1
exec 2> $tmp_dir/$prog.err.$d0.$d1

set -x

mkdir $tmp_dir/$d0
$prog_dir/job_pickles.py $tmp_dir/$d0 $d0 $d1
tar -C $tmp_dir -czf $dst_dir/$d0.tar.gz $d0
rm -r $tmp_dir/$d0
